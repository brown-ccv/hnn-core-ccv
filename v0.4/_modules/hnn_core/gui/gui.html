<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hnn_core.gui.gui &#8212; hnn-core  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css?v=9afac83c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=fd10adb8"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-199741045-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-199741045-1');
</script>


  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          hnn-core</a>
        <span class="navbar-text navbar-version pull-left"><b>0.4.dev0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../auto_examples/index.html">Examples</a></li>
                <li><a href="../../../gui/index.html">GUI</a></li>
                <li><a href="../../../api.html">API</a></li>
                <li><a href="../../../glossary.html">Glossary</a></li>
                <li><a href="../../../whats_new.html">What's new</a></li>
                <li><a href="https://github.com/jonescompneurolab/hnn-core">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
<div class="navbar-form navbar-right navbar-btn dropdown btn-group-sm" style="margin-left: 20px; margin-top: 5px; margin-bottom: 5px">
  <button type="button" class="btn btn-primary navbar-btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">
    v0.4.dev0
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
    <li><a href="https://jonescompneurolab.github.io/hnn-core/dev/index.html">Development</a></li>
    <li><a href="https://jonescompneurolab.github.io/hnn-core/stable/index.html">Stable</a></li>
    <li><a href="https://jonescompneurolab.github.io/hnn-core/v0.1/index.html">v0.1</a></li>
    <li><a href="https://jonescompneurolab.github.io/hnn-core/v0.2/index.html">v0.2</a></li>
    <li><a href="https://jonescompneurolab.github.io/hnn-core/v0.3/index.html">v0.3</a></li>
  </ul>
</div>


            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for hnn_core.gui.gui</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;IPywidgets GUI.&quot;&quot;&quot;</span>

<span class="c1"># Authors: Mainak Jas &lt;mjas@mgh.harvard.edu&gt;</span>
<span class="c1">#          Huzi Cheng &lt;hzcheng15@icloud.com&gt;</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">IFrame</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="p">(</span><span class="n">HTML</span><span class="p">,</span> <span class="n">Accordion</span><span class="p">,</span> <span class="n">AppLayout</span><span class="p">,</span> <span class="n">BoundedFloatText</span><span class="p">,</span>
                        <span class="n">BoundedIntText</span><span class="p">,</span> <span class="n">Button</span><span class="p">,</span> <span class="n">Dropdown</span><span class="p">,</span> <span class="n">FileUpload</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span>
                        <span class="n">HBox</span><span class="p">,</span> <span class="n">IntText</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">RadioButtons</span><span class="p">,</span> <span class="n">Tab</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span>
                        <span class="n">Checkbox</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ipywidgets.embed</span> <span class="kn">import</span> <span class="n">embed_minimal_html</span>
<span class="kn">import</span> <span class="nn">hnn_core</span>
<span class="kn">from</span> <span class="nn">hnn_core</span> <span class="kn">import</span> <span class="p">(</span><span class="n">JoblibBackend</span><span class="p">,</span> <span class="n">MPIBackend</span><span class="p">,</span> <span class="n">jones_2009_model</span><span class="p">,</span> <span class="n">read_params</span><span class="p">,</span>
                      <span class="n">simulate_dipole</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">hnn_core.gui._logging</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">hnn_core.gui._viz_manager</span> <span class="kn">import</span> <span class="n">_VizManager</span><span class="p">,</span> <span class="n">_idx2figname</span>
<span class="kn">from</span> <span class="nn">hnn_core.network</span> <span class="kn">import</span> <span class="n">pick_connection</span>
<span class="kn">from</span> <span class="nn">hnn_core.params</span> <span class="kn">import</span> <span class="n">_extract_drive_specs_from_hnn_params</span>
<span class="kn">from</span> <span class="nn">hnn_core.dipole</span> <span class="kn">import</span> <span class="n">_read_dipole_txt</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>


<span class="k">class</span> <span class="nc">_OutputWidgetHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_widget</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_OutputWidgetHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">output_widget</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">formatted_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="n">new_output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;stdout&#39;</span><span class="p">,</span>
            <span class="s1">&#39;output_type&#39;</span><span class="p">:</span> <span class="s1">&#39;stream&#39;</span><span class="p">,</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">formatted_record</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_output</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">outputs</span>


<div class="viewcode-block" id="HNNGUI">
<a class="viewcode-back" href="../../../generated/hnn_core.gui.HNNGUI.html#hnn_core.gui.HNNGUI">[docs]</a>
<span class="k">class</span> <span class="nc">HNNGUI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HNN GUI class</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theme_color : str</span>
<span class="sd">        The theme color of the whole dashboard.</span>
<span class="sd">    total_height : int</span>
<span class="sd">        The height of the GUI (in pixel, same for all following parameters).</span>
<span class="sd">    total_width : int</span>
<span class="sd">        The width of the GUI.</span>
<span class="sd">    header_height : int</span>
<span class="sd">        The height of the header.</span>
<span class="sd">    button_height : int</span>
<span class="sd">        The height of buttons.</span>
<span class="sd">    operation_box_height : int</span>
<span class="sd">        The operation_box_height of operations box.</span>
<span class="sd">    drive_widget_width : int</span>
<span class="sd">        The width of GUI drive box.</span>
<span class="sd">    left_sidebar_width : int</span>
<span class="sd">        The width of left sidebad.</span>
<span class="sd">    log_window_height : int</span>
<span class="sd">        The height of logging window.</span>
<span class="sd">    status_height : int</span>
<span class="sd">        The height of status bar.</span>
<span class="sd">    dpi : int</span>
<span class="sd">        The screen dpi.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    layout : dict</span>
<span class="sd">        The styling configuration of GUI.</span>
<span class="sd">    params : dict</span>
<span class="sd">        The parameters to use for constructing the network.</span>
<span class="sd">    simulation_data : dict</span>
<span class="sd">        Simulation related objects, such as net and dpls.</span>
<span class="sd">    widget_tstop : Widget</span>
<span class="sd">        Simulation stop time widget.</span>
<span class="sd">    widget_dt : Widget</span>
<span class="sd">        Simulation step size widget.</span>
<span class="sd">    widget_ntrials : Widget</span>
<span class="sd">        Widget that controls the number of trials in a single simulation.</span>
<span class="sd">    widget_backend_selection : Widget</span>
<span class="sd">        Widget that selects the backend used in simulations.</span>
<span class="sd">    widget_viz_layout_selection : Widget</span>
<span class="sd">        Widget that selects the layout of visualization window.</span>
<span class="sd">    widget_mpi_cmd : Widget</span>
<span class="sd">        Widget that specify the mpi command to use when the backend is</span>
<span class="sd">        MPIBackend.</span>
<span class="sd">    widget_n_jobs : Widget</span>
<span class="sd">        Widget that specify the cores in multi-trial simulations.</span>
<span class="sd">    widget_drive_type_selection : Widget</span>
<span class="sd">        Widget that is used to select the drive to be added to the network.</span>
<span class="sd">    widget_location_selection : Widget.</span>
<span class="sd">        Widget that specifies the location of network drives. Could be proximal</span>
<span class="sd">        or distal.</span>
<span class="sd">    add_drive_button : Widget</span>
<span class="sd">        Clickable widget that is used to add a drive to the network.</span>
<span class="sd">    run_button : Widget</span>
<span class="sd">        Clickable widget that triggers simulation.</span>
<span class="sd">    load_button : Widget</span>
<span class="sd">        Clickable widget that receives uploaded parameter files.</span>
<span class="sd">    delete_drive_button : Widget</span>
<span class="sd">        Clickable widget that clear all existing network drives.</span>
<span class="sd">    plot_outputs_dict : list</span>
<span class="sd">        A list of visualization panel outputs.</span>
<span class="sd">    plot_dropdown_types_dict : list</span>
<span class="sd">        A list of dropdown menus that control the plot types in</span>
<span class="sd">        plot_outputs_dict.</span>
<span class="sd">    drive_widgets : list</span>
<span class="sd">        A list of network drive widgets added by add_drive_button.</span>
<span class="sd">    drive_boxes : list</span>
<span class="sd">        A list of network drive layouts.</span>
<span class="sd">    connectivity_textfields : list</span>
<span class="sd">        A list of boxes that control the weight and probability of connections</span>
<span class="sd">        in the network.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theme_color</span><span class="o">=</span><span class="s2">&quot;#8A2BE2&quot;</span><span class="p">,</span>
                 <span class="n">total_height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                 <span class="n">total_width</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span>
                 <span class="n">header_height</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                 <span class="n">button_height</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">operation_box_height</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                 <span class="n">drive_widget_width</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                 <span class="n">left_sidebar_width</span><span class="o">=</span><span class="mi">576</span><span class="p">,</span>
                 <span class="n">log_window_height</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                 <span class="n">status_height</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="c1"># set up styling.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_height</span> <span class="o">=</span> <span class="n">total_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_width</span> <span class="o">=</span> <span class="n">total_width</span>

        <span class="n">viz_win_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_width</span> <span class="o">-</span> <span class="n">left_sidebar_width</span>
        <span class="n">main_content_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_height</span> <span class="o">-</span> <span class="n">status_height</span>

        <span class="n">config_box_height</span> <span class="o">=</span> <span class="n">main_content_height</span> <span class="o">-</span> <span class="p">(</span><span class="n">log_window_height</span> <span class="o">+</span>
                                                   <span class="n">operation_box_height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dpi&quot;</span><span class="p">:</span> <span class="n">dpi</span><span class="p">,</span>
            <span class="s2">&quot;header_height&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
            <span class="s2">&quot;theme_color&quot;</span><span class="p">:</span> <span class="n">theme_color</span><span class="p">,</span>
            <span class="s2">&quot;btn&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">button_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">),</span>
            <span class="s2">&quot;run_btn&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">button_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;10%&#39;</span><span class="p">),</span>
            <span class="s2">&quot;btn_full_w&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">button_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">),</span>
            <span class="s2">&quot;del_fig_btn&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">button_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">),</span>
            <span class="s2">&quot;log_out&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">border</span><span class="o">=</span><span class="s1">&#39;1px solid gray&#39;</span><span class="p">,</span>
                              <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_window_height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                              <span class="n">overflow</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">),</span>
            <span class="s2">&quot;viz_config&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;99%&#39;</span><span class="p">),</span>
            <span class="s2">&quot;simulations_list&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">left_sidebar_width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="si">}</span><span class="s1">px&#39;</span><span class="p">),</span>
            <span class="s2">&quot;visualization_window&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span>
                <span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">viz_win_width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_content_height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                <span class="n">border</span><span class="o">=</span><span class="s1">&#39;1px solid gray&#39;</span><span class="p">,</span>
                <span class="n">overflow</span><span class="o">=</span><span class="s1">&#39;scroll&#39;</span><span class="p">),</span>
            <span class="s2">&quot;visualization_output&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span>
                <span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">viz_win_width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">50</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_content_height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                <span class="n">border</span><span class="o">=</span><span class="s1">&#39;1px solid gray&#39;</span><span class="p">,</span>
                <span class="n">overflow</span><span class="o">=</span><span class="s1">&#39;scroll&#39;</span><span class="p">),</span>
            <span class="s2">&quot;left_sidebar&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_sidebar_width</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                                   <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">main_content_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">),</span>
            <span class="s2">&quot;left_tab&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_sidebar_width</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                               <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_box_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">),</span>
            <span class="s2">&quot;operation_box&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_sidebar_width</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                                    <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation_box_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                                    <span class="n">flex_wrap</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">,</span>
                                    <span class="p">),</span>
            <span class="s2">&quot;config_box&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_sidebar_width</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
                                 <span class="n">height</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_box_height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">),</span>
            <span class="s2">&quot;drive_widget&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
            <span class="s2">&quot;drive_textbox&quot;</span><span class="p">:</span> <span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;270px&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">),</span>
            <span class="c1"># simulation status related</span>
            <span class="s2">&quot;simulation_status_height&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_height</span><span class="si">}</span><span class="s2">px&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simulation_status_common&quot;</span><span class="p">:</span> <span class="s2">&quot;background:gray;padding-left:10px&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simulation_status_running&quot;</span><span class="p">:</span> <span class="s2">&quot;background:orange;padding-left:10px&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simulation_status_failed&quot;</span><span class="p">:</span> <span class="s2">&quot;background:red;padding-left:10px&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simulation_status_finished&quot;</span><span class="p">:</span> <span class="s2">&quot;background:green;padding-left:10px&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status_contents</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;not_running&quot;</span><span class="p">:</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div style=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;simulation_status_common&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            color:white;&#39;&gt;Not running&lt;/div&gt;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;running&quot;</span><span class="p">:</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div style=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;simulation_status_running&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            color:white;&#39;&gt;Running...&lt;/div&gt;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finished&quot;</span><span class="p">:</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div style=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;simulation_status_finished&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            color:white;&#39;&gt;Simulation finished&lt;/div&gt;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div style=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;simulation_status_failed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            color:white;&#39;&gt;Simulation failed&lt;/div&gt;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># load default parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">()</span>

        <span class="c1"># In-memory storage of all simulation and visualization related data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">net</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpls</span><span class="o">=</span><span class="nb">list</span><span class="p">()))</span>

        <span class="c1"># Simulation parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">170</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;tstop (ms):&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_dt</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;dt (ms):&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_ntrials</span> <span class="o">=</span> <span class="n">IntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Trials:&#39;</span><span class="p">,</span>
                                      <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_simulation_name</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                                           <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;ID of your simulation&#39;</span><span class="p">,</span>
                                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Name:&#39;</span><span class="p">,</span>
                                           <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_backend_selection</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Joblib&#39;</span><span class="p">,</span> <span class="s1">&#39;Joblib&#39;</span><span class="p">),</span>
                                                          <span class="p">(</span><span class="s1">&#39;MPI&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI&#39;</span><span class="p">)],</span>
                                                 <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Joblib&#39;</span><span class="p">,</span>
                                                 <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Backend:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_mpi_cmd</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span>
                                   <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;Fill if applies&#39;</span><span class="p">,</span>
                                   <span class="n">description</span><span class="o">=</span><span class="s1">&#39;MPI cmd:&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_n_jobs</span> <span class="o">=</span> <span class="n">BoundedIntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="nb">max</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Cores:&#39;</span><span class="p">,</span>
                                            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data_button</span> <span class="o">=</span> <span class="n">FileUpload</span><span class="p">(</span>
            <span class="n">accept</span><span class="o">=</span><span class="s1">&#39;.txt,.csv&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;button_color&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">]},</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;btn&#39;</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Load data&#39;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">)</span>

        <span class="c1"># Create save simulation widget wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_simuation_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_html_download_button</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_list_widget</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[],</span>
                                               <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                               <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;15%&#39;</span><span class="p">})</span>
        <span class="c1"># Drive selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_drive_type_selection</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Evoked&#39;</span><span class="p">,</span> <span class="s1">&#39;Poisson&#39;</span><span class="p">,</span> <span class="s1">&#39;Rhythmic&#39;</span><span class="p">,</span> <span class="s1">&#39;Tonic&#39;</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Evoked&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Drive:&#39;</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;drive_widget&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_location_selection</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;proximal&#39;</span><span class="p">,</span> <span class="s1">&#39;distal&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;proximal&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;drive_widget&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_drive_button</span> <span class="o">=</span> <span class="n">create_expanded_button</span><span class="p">(</span>
            <span class="s1">&#39;Add drive&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;btn&#39;</span><span class="p">],</span>
            <span class="n">button_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">])</span>

        <span class="c1"># Dashboard level buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">create_expanded_button</span><span class="p">(</span>
            <span class="s1">&#39;Run&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;run_btn&#39;</span><span class="p">],</span>
            <span class="n">button_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_connectivity_button</span> <span class="o">=</span> <span class="n">FileUpload</span><span class="p">(</span>
            <span class="n">accept</span><span class="o">=</span><span class="s1">&#39;.json,.param&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;button_color&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">]},</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Load local network connectivity&#39;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;btn_full_w&#39;</span><span class="p">],</span> <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_drives_button</span> <span class="o">=</span> <span class="n">FileUpload</span><span class="p">(</span>
            <span class="n">accept</span><span class="o">=</span><span class="s1">&#39;.json,.param&#39;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;button_color&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">]},</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Load external drives&#39;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;btn&#39;</span><span class="p">],</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delete_drive_button</span> <span class="o">=</span> <span class="n">create_expanded_button</span><span class="p">(</span>
            <span class="s1">&#39;Delete drives&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;btn&#39;</span><span class="p">],</span>
            <span class="n">button_color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">])</span>

        <span class="c1"># Plotting window</span>

        <span class="c1"># Visualization figure related dicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_outputs_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_dropdown_types_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_sim_selections_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Add drive section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drive_boxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Connectivity list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_widgets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_ui_components</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_logging_window_logger</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_html_download_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="c1"># Initialliting HTML code for download button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html_download_button</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        &lt;a download=&quot;</span><span class="si">{filename}</span><span class="s1">&quot; href=&quot;data:text/csv;base64,</span><span class="si">{payload}</span><span class="s1">&quot;</span>
<span class="s1">          download&gt;</span>
<span class="s1">        &lt;button style=&quot;background:</span><span class="si">{color_theme}</span><span class="s1">; height:</span><span class="si">{btn_height}</span><span class="s1">&quot;</span>
<span class="s1">        class=&quot; jupyter-button</span>
<span class="s1">           mod-warning&quot; </span><span class="si">{is_disabled}</span><span class="s1"> &gt;Save Simulation&lt;/button&gt;</span>
<span class="s1">        &lt;/a&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="c1"># Create widget wrapper</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">HTML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_download_button</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">},</span>
                        <span class="n">is_disabled</span><span class="o">=</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span>
                        <span class="n">btn_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;run_btn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                        <span class="n">color_theme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">])))</span>

    <span class="k">def</span> <span class="nf">add_logging_window_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">_OutputWidgetHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">  - [</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_ui_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize larger UI components and dynamical output windows.</span>

<span class="sd">        It&#39;s not encouraged for users to modify or access attributes in this</span>
<span class="sd">        part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># dynamic larger components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>  <span class="c1"># tab to add new drives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connectivity_out</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>  <span class="c1"># tab to tune connectivity.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">viz_manager</span> <span class="o">=</span> <span class="n">_VizManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>

        <span class="c1"># detailed configuration of backends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend_config_out</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>

        <span class="c1"># static parts</span>
        <span class="c1"># Running status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status_bar</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status_contents</span><span class="p">[</span><span class="s1">&#39;not_running&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_window</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;log_out&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_operation_buttons</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data_button</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">save_simuation_button</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">simulation_list_widget</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;operation_box&#39;</span><span class="p">])</span>
        <span class="c1"># title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div</span>
<span class="s2">            style=&#39;background:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">            text-align:center;color:white;&#39;&gt;</span>
<span class="s2">            HUMAN NEOCORTICAL NEUROSOLVER&lt;/div&gt;&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">analysis_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides everything viz window needs except for the data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;viz_style&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;visualization_output&#39;</span><span class="p">],</span>
            <span class="c1"># widgets</span>
            <span class="s2">&quot;plot_outputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_outputs_dict</span><span class="p">,</span>
            <span class="s2">&quot;plot_dropdowns&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_dropdown_types_dict</span><span class="p">,</span>
            <span class="s2">&quot;plot_sim_selections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_sim_selections_dict</span><span class="p">,</span>
            <span class="s2">&quot;current_sim_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_simulation_name</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides easy access to simulation-related data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;simulation_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_data</span><span class="p">}</span>

<div class="viewcode-block" id="HNNGUI.load_parameters">
<a class="viewcode-back" href="../../../generated/hnn_core.gui.HNNGUI.html#hnn_core.gui.HNNGUI.load_parameters">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_parameters</span><span class="p">(</span><span class="n">params_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read parameters from file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_fname</span><span class="p">:</span>
            <span class="c1"># by default load default.json</span>
            <span class="n">hnn_core_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">hnn_core</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">params_fname</span> <span class="o">=</span> <span class="n">hnn_core_root</span> <span class="o">/</span> <span class="s1">&#39;param/default.json&#39;</span>
        <span class="k">return</span> <span class="n">read_params</span><span class="p">(</span><span class="n">params_fname</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_link_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Link callbacks to UI components.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_handle_backend_change</span><span class="p">(</span><span class="n">backend_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">handle_backend_change</span><span class="p">(</span><span class="n">backend_type</span><span class="o">.</span><span class="n">new</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_backend_config_out</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">widget_mpi_cmd</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">widget_n_jobs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_add_drive_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">add_drive_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget_drive_type_selection</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">drive_boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">widget_location_selection</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                    <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;drive_textbox&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">_delete_drives_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
            <span class="c1"># black magic: the following does not work</span>
            <span class="c1"># global drive_widgets; drive_widgets = list()</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drive_boxes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_on_upload_connectivity</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">on_upload_params_change</span><span class="p">(</span>
                <span class="n">change</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_dt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connectivity_out</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_widgets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;drive_textbox&#39;</span><span class="p">],</span>
                <span class="s2">&quot;connectivity&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_on_upload_drives</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">on_upload_params_change</span><span class="p">(</span>
                <span class="n">change</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_dt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connectivity_out</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_widgets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;drive_textbox&#39;</span><span class="p">],</span>
                <span class="s2">&quot;drives&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_on_upload_data</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">on_upload_data_change</span><span class="p">(</span><span class="n">change</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viz_manager</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_run_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">run_button_clicked</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget_simulation_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget_ntrials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_backend_selection</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget_mpi_cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_n_jobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status_bar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status_contents</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_widgets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viz_manager</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulation_list_widget</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_simulation_list_change</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">_simulation_data</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_serialize_simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">simulation_list_widget</span><span class="p">))</span>

            <span class="n">result_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">new</span><span class="si">}{</span><span class="n">file_extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
                <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">_simulation_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">_simulation_data</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_simuation_button</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">html_download_button</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">result_file</span><span class="p">,</span>
                    <span class="n">is_disabled</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">btn_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;run_btn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                    <span class="n">color_theme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;theme_color&#39;</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">_driver_type_change</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widget_location_selection</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">True</span> <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">new</span> <span class="o">==</span> <span class="s2">&quot;Tonic&quot;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">widget_backend_selection</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">_handle_backend_change</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_drive_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_add_drive_button_clicked</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_drive_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_delete_drives_clicked</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_connectivity_button</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">_on_upload_connectivity</span><span class="p">,</span>
                                              <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_drives_button</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">_on_upload_drives</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_run_button_clicked</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data_button</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">_on_upload_data</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_list_widget</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">_simulation_list_change</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget_drive_type_selection</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">_driver_type_change</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="HNNGUI.compose">
<a class="viewcode-back" href="../../../generated/hnn_core.gui.HNNGUI.html#hnn_core.gui.HNNGUI.compose">[docs]</a>
    <span class="k">def</span> <span class="nf">compose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compose widgets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        return_layout : bool</span>
<span class="sd">            If the method returns the layout object which can be rendered by</span>
<span class="sd">            IPython.display.display() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
            <span class="n">VBox</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget_simulation_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_dt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget_ntrials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_backend_selection</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_backend_config_out</span><span class="p">]),</span>
        <span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;config_box&#39;</span><span class="p">])</span>

        <span class="n">connectivity_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
            <span class="n">HBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">load_connectivity_button</span><span class="p">,</span> <span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connectivity_out</span><span class="p">,</span>
        <span class="p">])</span>

        <span class="c1"># accordions to group local-connectivity by cell type</span>
        <span class="n">connectivity_boxes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">VBox</span><span class="p">(</span><span class="n">slider</span><span class="p">)</span> <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_widgets</span><span class="p">]</span>
        <span class="n">connectivity_names</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Layer 2/3 Pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;Layer 5 Pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;Layer 2 Basket&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Layer 5 Basket&#39;</span><span class="p">)</span>
        <span class="n">cell_connectivity</span> <span class="o">=</span> <span class="n">Accordion</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">connectivity_boxes</span><span class="p">)</span>
        <span class="n">cell_connectivity</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">connectivity_names</span><span class="p">]</span>

        <span class="n">drive_selections</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_drive_button</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_drive_type_selection</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widget_location_selection</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">flex</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>

        <span class="n">drives_options</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
            <span class="n">HBox</span><span class="p">([</span>
                <span class="n">VBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">load_drives_button</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_drive_button</span><span class="p">],</span>
                     <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">flex</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)),</span>
                <span class="n">drive_selections</span><span class="p">,</span>
            <span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span>
        <span class="p">])</span>

        <span class="n">config_panel</span><span class="p">,</span> <span class="n">figs_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viz_manager</span><span class="o">.</span><span class="n">compose</span><span class="p">()</span>

        <span class="c1"># Tabs for left pane</span>
        <span class="n">left_tab</span> <span class="o">=</span> <span class="n">Tab</span><span class="p">()</span>
        <span class="n">left_tab</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">simulation_box</span><span class="p">,</span> <span class="n">connectivity_box</span><span class="p">,</span> <span class="n">drives_options</span><span class="p">,</span>
            <span class="n">config_panel</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Simulation&#39;</span><span class="p">,</span> <span class="s1">&#39;Network connectivity&#39;</span><span class="p">,</span> <span class="s1">&#39;External drives&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Visualization&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">titles</span><span class="p">):</span>
            <span class="n">left_tab</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app_layout</span> <span class="o">=</span> <span class="n">AppLayout</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span>
            <span class="n">left_sidebar</span><span class="o">=</span><span class="n">VBox</span><span class="p">([</span>
                <span class="n">VBox</span><span class="p">([</span><span class="n">left_tab</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;left_tab&#39;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_operation_buttons</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_window</span><span class="p">,</span>
            <span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;left_sidebar&#39;</span><span class="p">]),</span>
            <span class="n">right_sidebar</span><span class="o">=</span><span class="n">figs_output</span><span class="p">,</span>
            <span class="n">footer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status_bar</span><span class="p">,</span>
            <span class="n">pane_widths</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;left_sidebar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="s1">&#39;0px&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;visualization_window&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
            <span class="p">],</span>
            <span class="n">pane_heights</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;header_height&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;visualization_window&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;simulation_status_height&#39;</span><span class="p">]</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_link_callbacks</span><span class="p">()</span>

        <span class="c1"># initialize drive and connectivity ipywidgets</span>
        <span class="n">load_drive_and_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_out</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_drives_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_widgets</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">drive_boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connectivity_out</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">connectivity_widgets</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">widget_tstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_layout</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_layout</span></div>


    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_layout</span><span class="p">)</span>

<div class="viewcode-block" id="HNNGUI.capture">
<a class="viewcode-back" href="../../../generated/hnn_core.gui.HNNGUI.html#hnn_core.gui.HNNGUI.capture">[docs]</a>
    <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_margin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a screenshot of the current GUI.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        width : int | None</span>
<span class="sd">            The width of iframe window use to show the snapshot.</span>
<span class="sd">        height : int | None</span>
<span class="sd">            The height of iframe window use to show the snapshot.</span>
<span class="sd">        extra_margin: int</span>
<span class="sd">            Extra margin in pixel for the GUI.</span>
<span class="sd">        render : bool</span>
<span class="sd">            Will return an IFrame object if False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        snapshot : An iframe snapshot object that can be rendered in notebooks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">embed_minimal_html</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">views</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app_layout</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">width</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_width</span> <span class="o">+</span> <span class="n">extra_margin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">height</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_height</span> <span class="o">+</span> <span class="n">extra_margin</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
        <span class="n">data_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:text/html,</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">screenshot</span> <span class="o">=</span> <span class="n">IFrame</span><span class="p">(</span><span class="n">data_url</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">screenshot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">screenshot</span></div>


<div class="viewcode-block" id="HNNGUI.run_notebook_cells">
<a class="viewcode-back" href="../../../generated/hnn_core.gui.HNNGUI.html#hnn_core.gui.HNNGUI.run_notebook_cells">[docs]</a>
    <span class="k">def</span> <span class="nf">run_notebook_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all but the last cells sequentially in a Jupyter notebook.</span>

<span class="sd">        To properly use this function:</span>
<span class="sd">            1. Put this into the penultimate cell.</span>
<span class="sd">            2. init the HNNGUI in a single cell.</span>
<span class="sd">            3. Hit &#39;run all&#39; button to run the whole notebook and it will</span>
<span class="sd">               selectively run twice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">js_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        function sleep(ms) {</span>
<span class="s2">        return new Promise(resolve =&gt; setTimeout(resolve, ms));</span>
<span class="s2">        }</span>
<span class="s2">        function getRunningStatus(idx){</span>
<span class="s2">            const htmlContent = Jupyter.notebook.get_cell(idx).element[0];</span>
<span class="s2">            return htmlContent.childNodes[0].childNodes[0].textContent;</span>
<span class="s2">        }</span>
<span class="s2">        function cellContainsInitOrMarkdown(idx){</span>
<span class="s2">            const cell = Jupyter.notebook.get_cell(idx);</span>
<span class="s2">            if(cell.cell_type!==&#39;code&#39;){</span>
<span class="s2">                return true;</span>
<span class="s2">            }</span>
<span class="s2">            else{</span>
<span class="s2">                const textVal = cell.element[0].childNodes[0].textContent;</span>
<span class="s2">                return textVal.includes(&#39;HNNGUI()&#39;) || textVal.includes(</span>
<span class="s2">                    &#39;HNNGUI&#39;);</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        function cellContainsRunCells(idx){</span>
<span class="s2">            const textVal = Jupyter.notebook.get_cell(</span>
<span class="s2">                idx).element[0].childNodes[0].textContent;</span>
<span class="s2">            return textVal.includes(&#39;run_notebook_cells()&#39;);</span>
<span class="s2">        }</span>
<span class="s2">        async function runNotebook() {</span>
<span class="s2">            console.log(&quot;run notebook cell by cell&quot;);</span>
<span class="s2">            const cellHtmlContents = Jupyter.notebook.element[0].children[0];</span>
<span class="s2">            const nCells = cellHtmlContents.childElementCount;</span>
<span class="s2">            console.log(`In total we have $</span><span class="si">{nCells}</span><span class="s2"> cells`);</span>

<span class="s2">            for(let i=1; i&lt;nCells-1; i++){</span>
<span class="s2">                if(cellContainsRunCells(i)){</span>
<span class="s2">                    break</span>
<span class="s2">                }</span>
<span class="s2">                else if(cellContainsInitOrMarkdown(i)){</span>
<span class="s2">                    console.log(`Skip init or markdown cell $</span><span class="si">{i}</span><span class="s2">...`);</span>
<span class="s2">                    continue</span>
<span class="s2">                }</span>
<span class="s2">                else{</span>
<span class="s2">                    console.log(`About to execute cell $</span><span class="si">{i}</span><span class="s2">..`);</span>
<span class="s2">                    Jupyter.notebook.execute_cells([i]);</span>
<span class="s2">                    while (getRunningStatus(i).includes(&quot;*&quot;)){</span>
<span class="s2">                        console.log(&quot;Still running, wait for another 2 secs&quot;);</span>
<span class="s2">                        await sleep(2000);</span>
<span class="s2">                    }</span>
<span class="s2">                    await sleep(1000);</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">            console.log(&#39;Done&#39;);</span>
<span class="s2">        }</span>
<span class="s2">        runNotebook();</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">js_string</span></div>


    <span class="c1"># below are a series of methods that are used to manipulate the GUI</span>
    <span class="k">def</span> <span class="nf">_simulate_upload_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_url</span><span class="p">):</span>
        <span class="n">uploaded_value</span> <span class="o">=</span> <span class="n">_prepare_upload_file_from_url</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data_button</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">uploaded_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simulate_upload_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_url</span><span class="p">):</span>
        <span class="n">uploaded_value</span> <span class="o">=</span> <span class="n">_prepare_upload_file_from_url</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_connectivity_button</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">uploaded_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simulate_upload_drives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_url</span><span class="p">):</span>
        <span class="n">uploaded_value</span> <span class="o">=</span> <span class="n">_prepare_upload_file_from_url</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_drives_button</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">uploaded_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simulate_left_tab_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab_title</span><span class="p">):</span>
        <span class="c1"># Get left tab group object</span>
        <span class="n">left_tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_layout</span><span class="o">.</span><span class="n">left_sidebar</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Check that the title is in the tab group</span>
        <span class="k">if</span> <span class="n">tab_title</span> <span class="ow">in</span> <span class="n">left_tab</span><span class="o">.</span><span class="n">titles</span><span class="p">:</span>
            <span class="c1"># Simulate the user clicking on the tab</span>
            <span class="n">left_tab</span><span class="o">.</span><span class="n">selected_index</span> <span class="o">=</span> <span class="n">left_tab</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tab_title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tab title does not exist.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simulate_make_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_left_tab_click</span><span class="p">(</span><span class="s2">&quot;Visualization&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viz_manager</span><span class="o">.</span><span class="n">make_fig_button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_simulate_viz_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A shortcut to call simulated actions in _VizManager.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action_name : str</span>
<span class="sd">            The action to take. For example, to call `_simulate_add_fig` in</span>
<span class="sd">            _VizManager, you can run `_simulate_viz_action(&quot;add_fig&quot;)`</span>
<span class="sd">        args : list</span>
<span class="sd">            Optional positional parameters passed to the called method.</span>
<span class="sd">        kwargs: dict</span>
<span class="sd">            Optional keyword parameters passed to the called method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_left_tab_click</span><span class="p">(</span><span class="s2">&quot;Visualization&quot;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viz_manager</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_simulate_</span><span class="si">{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">action</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_prepare_upload_file_from_url</span><span class="p">(</span><span class="n">file_url</span><span class="p">):</span>
    <span class="n">params_name</span> <span class="o">=</span> <span class="n">file_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">+=</span> <span class="n">line</span>

    <span class="k">return</span> <span class="p">[{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">params_name</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
        <span class="s1">&#39;last_modified&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">}]</span>


<span class="k">def</span> <span class="nf">create_expanded_button</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">button_style</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">button_color</span><span class="o">=</span><span class="s2">&quot;#8A2BE2&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="n">button_style</span><span class="p">,</span>
                  <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;button_color&#39;</span><span class="p">:</span> <span class="n">button_color</span><span class="p">},</span>
                  <span class="n">disabled</span><span class="o">=</span><span class="n">disabled</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_connectivity_widgets</span><span class="p">(</span><span class="n">conn_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create connectivity box widgets from specified weight and probability&quot;&quot;&quot;</span>

    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;150px&#39;</span><span class="p">}</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sliders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">receptor_name</span> <span class="ow">in</span> <span class="n">conn_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">w_text_input</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">conn_data</span><span class="p">[</span><span class="n">receptor_name</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">],</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

        <span class="n">conn_widget</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span>
            <span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;p&gt;</span>
<span class="s2">            Receptor: </span><span class="si">{</span><span class="n">conn_data</span><span class="p">[</span><span class="n">receptor_name</span><span class="p">][</span><span class="s1">&#39;receptor&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">w_text_input</span><span class="p">,</span> <span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;hr style=&#39;margin-bottom:5px&#39;/&gt;&quot;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">conn_widget</span><span class="o">.</span><span class="n">_belongsto</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;receptor&quot;</span><span class="p">:</span> <span class="n">conn_data</span><span class="p">[</span><span class="n">receptor_name</span><span class="p">][</span><span class="s1">&#39;receptor&#39;</span><span class="p">],</span>
            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">conn_data</span><span class="p">[</span><span class="n">receptor_name</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
            <span class="s2">&quot;src_gids&quot;</span><span class="p">:</span> <span class="n">conn_data</span><span class="p">[</span><span class="n">receptor_name</span><span class="p">][</span><span class="s1">&#39;src_gids&#39;</span><span class="p">],</span>
            <span class="s2">&quot;target_gids&quot;</span><span class="p">:</span> <span class="n">conn_data</span><span class="p">[</span><span class="n">receptor_name</span><span class="p">][</span><span class="s1">&#39;target_gids&#39;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">sliders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_widget</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sliders</span>


<span class="k">def</span> <span class="nf">_get_cell_specific_widgets</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;weights_ampa&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;L5_basket&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;L2_basket&#39;</span><span class="p">:</span> <span class="mf">0.</span>
        <span class="p">},</span>
        <span class="s1">&#39;weights_nmda&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;L5_basket&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;L2_basket&#39;</span><span class="p">:</span> <span class="mf">0.</span>
        <span class="p">},</span>
        <span class="s1">&#39;delays&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;L5_basket&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;L2_basket&#39;</span><span class="p">:</span> <span class="mf">0.1</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="n">cell_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;L5_basket&#39;</span><span class="p">,</span> <span class="s1">&#39;L2_basket&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;distal&quot;</span><span class="p">:</span>
        <span class="n">cell_types</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;L5_basket&#39;</span><span class="p">)</span>

    <span class="n">weights_ampa</span><span class="p">,</span> <span class="n">weights_nmda</span><span class="p">,</span> <span class="n">delays</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
        <span class="n">weights_ampa</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;weights_ampa&#39;</span><span class="p">][</span><span class="n">cell_type</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">weights_nmda</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;weights_nmda&#39;</span><span class="p">][</span><span class="n">cell_type</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">delays</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;delays&#39;</span><span class="p">][</span><span class="n">cell_type</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">widgets_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;weights_ampa&#39;</span><span class="p">:</span> <span class="n">weights_ampa</span><span class="p">,</span>
        <span class="s1">&#39;weights_nmda&#39;</span><span class="p">:</span> <span class="n">weights_nmda</span><span class="p">,</span>
        <span class="s1">&#39;delays&#39;</span><span class="p">:</span> <span class="n">delays</span>
    <span class="p">}</span>
    <span class="n">widgets_list</span> <span class="o">=</span> <span class="p">([</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;AMPA weights&lt;/b&gt;&quot;</span><span class="p">)]</span> <span class="o">+</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">weights_ampa</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span>
                    <span class="p">[</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;NMDA weights&lt;/b&gt;&quot;</span><span class="p">)]</span> <span class="o">+</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">weights_nmda</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span>
                    <span class="p">[</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;Synaptic delays&lt;/b&gt;&quot;</span><span class="p">)]</span> <span class="o">+</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">delays</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">widgets_list</span><span class="p">,</span> <span class="n">widgets_dict</span>


<span class="k">def</span> <span class="nf">_get_rhythmic_widget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tstop_widget</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span>
                         <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_weights_ampa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">default_weights_nmda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">sync_evinput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tstart&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
        <span class="s1">&#39;tstart_std&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
        <span class="s1">&#39;tstop&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
        <span class="s1">&#39;burst_rate&#39;</span><span class="p">:</span> <span class="mf">7.5</span><span class="p">,</span>
        <span class="s1">&#39;burst_std&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;repeats&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;seedcore&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">default_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Start time (ms)&#39;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">tstart_std</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;tstart_std&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Start time dev (ms)&#39;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">],</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Stop time (ms)&#39;</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">tstop_widget</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">burst_rate</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;burst_rate&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Burst rate (Hz)&#39;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">burst_std</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;burst_std&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Burst std dev (Hz)&#39;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">repeats</span> <span class="o">=</span> <span class="n">BoundedIntText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;repeats&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Repeats&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">seedcore</span> <span class="o">=</span> <span class="n">IntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;seedcore&#39;</span><span class="p">],</span>
                       <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Seed&#39;</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">sync_inputs</span> <span class="o">=</span> <span class="n">Checkbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">sync_evinput</span><span class="p">,</span>
                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Synchronous Inputs&#39;</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">widgets_list</span><span class="p">,</span> <span class="n">widgets_dict</span> <span class="o">=</span> <span class="n">_get_cell_specific_widgets</span><span class="p">(</span>
        <span class="n">layout</span><span class="p">,</span>
        <span class="n">style</span><span class="p">,</span>
        <span class="n">location</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;weights_ampa&#39;</span><span class="p">:</span> <span class="n">default_weights_ampa</span><span class="p">,</span>
            <span class="s1">&#39;weights_nmda&#39;</span><span class="p">:</span> <span class="n">default_weights_nmda</span><span class="p">,</span>
            <span class="s1">&#39;delays&#39;</span><span class="p">:</span> <span class="n">default_delays</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">drive_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstart_std</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span>
                      <span class="n">burst_rate</span><span class="p">,</span> <span class="n">burst_std</span><span class="p">,</span> <span class="n">repeats</span><span class="p">,</span>
                      <span class="n">seedcore</span><span class="p">,</span> <span class="n">sync_inputs</span><span class="p">]</span> <span class="o">+</span>
                     <span class="n">widgets_list</span><span class="p">)</span>

    <span class="n">drive</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Rhythmic&#39;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span>
                 <span class="n">tstart_std</span><span class="o">=</span><span class="n">tstart_std</span><span class="p">,</span>
                 <span class="n">burst_rate</span><span class="o">=</span><span class="n">burst_rate</span><span class="p">,</span>
                 <span class="n">burst_std</span><span class="o">=</span><span class="n">burst_std</span><span class="p">,</span>
                 <span class="n">repeats</span><span class="o">=</span><span class="n">repeats</span><span class="p">,</span>
                 <span class="n">seedcore</span><span class="o">=</span><span class="n">seedcore</span><span class="p">,</span>
                 <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                 <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span>
                 <span class="n">is_synch_inputs</span><span class="o">=</span><span class="n">sync_inputs</span><span class="p">)</span>
    <span class="n">drive</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">widgets_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span>


<span class="k">def</span> <span class="nf">_get_poisson_widget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tstop_widget</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">default_weights_ampa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_weights_nmda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">default_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sync_evinput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;tstart&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s1">&#39;tstop&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s1">&#39;seedcore&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
        <span class="s1">&#39;rate_constant&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>
            <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>
            <span class="s1">&#39;L5_basket&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>
            <span class="s1">&#39;L2_basket&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">default_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Start time (ms)&#39;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">],</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">tstop_widget</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Stop time (ms)&#39;</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">seedcore</span> <span class="o">=</span> <span class="n">IntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;seedcore&#39;</span><span class="p">],</span>
                       <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Seed&#39;</span><span class="p">,</span>
                       <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
                       <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="n">sync_inputs</span> <span class="o">=</span> <span class="n">Checkbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">sync_evinput</span><span class="p">,</span>
                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Synchronous Inputs&#39;</span><span class="p">,</span>
                           <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
                           <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="n">cell_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;L5_basket&#39;</span><span class="p">,</span> <span class="s1">&#39;L2_basket&#39;</span><span class="p">]</span>
    <span class="n">rate_constant</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
        <span class="n">rate_constant</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;rate_constant&#39;</span><span class="p">][</span><span class="n">cell_type</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="n">widgets_list</span><span class="p">,</span> <span class="n">widgets_dict</span> <span class="o">=</span> <span class="n">_get_cell_specific_widgets</span><span class="p">(</span>
        <span class="n">layout</span><span class="p">,</span>
        <span class="n">style</span><span class="p">,</span>
        <span class="n">location</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;weights_ampa&#39;</span><span class="p">:</span> <span class="n">default_weights_ampa</span><span class="p">,</span>
            <span class="s1">&#39;weights_nmda&#39;</span><span class="p">:</span> <span class="n">default_weights_nmda</span><span class="p">,</span>
            <span class="s1">&#39;delays&#39;</span><span class="p">:</span> <span class="n">default_delays</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">widgets_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;rate_constant&#39;</span><span class="p">:</span> <span class="n">rate_constant</span><span class="p">})</span>
    <span class="n">widgets_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;Rate constants&lt;/b&gt;&quot;</span><span class="p">)]</span> <span class="o">+</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">widgets_dict</span><span class="p">[</span><span class="s1">&#39;rate_constant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">drive_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">seedcore</span><span class="p">,</span> <span class="n">sync_inputs</span><span class="p">]</span> <span class="o">+</span> <span class="n">widgets_list</span><span class="p">)</span>
    <span class="n">drive</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Poisson&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span>
        <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span>
        <span class="n">rate_constant</span><span class="o">=</span><span class="n">rate_constant</span><span class="p">,</span>
        <span class="n">seedcore</span><span class="o">=</span><span class="n">seedcore</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>  <span class="c1"># notice this is a widget but a str!</span>
        <span class="n">is_synch_inputs</span><span class="o">=</span><span class="n">sync_inputs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">drive</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">widgets_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span>


<span class="k">def</span> <span class="nf">_get_evoked_widget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">default_weights_ampa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_weights_nmda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">default_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sync_evinput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;numspikes&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;seedcore&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">default_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Mean time:&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Std dev time:&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">numspikes</span> <span class="o">=</span> <span class="n">IntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;numspikes&#39;</span><span class="p">],</span>
                        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;No. Spikes:&#39;</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">seedcore</span> <span class="o">=</span> <span class="n">IntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;seedcore&#39;</span><span class="p">],</span>
                       <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Seed: &#39;</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">sync_inputs</span> <span class="o">=</span> <span class="n">Checkbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">sync_evinput</span><span class="p">,</span>
                           <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Synchronous Inputs&#39;</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">widgets_list</span><span class="p">,</span> <span class="n">widgets_dict</span> <span class="o">=</span> <span class="n">_get_cell_specific_widgets</span><span class="p">(</span>
        <span class="n">layout</span><span class="p">,</span>
        <span class="n">style</span><span class="p">,</span>
        <span class="n">location</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;weights_ampa&#39;</span><span class="p">:</span> <span class="n">default_weights_ampa</span><span class="p">,</span>
            <span class="s1">&#39;weights_nmda&#39;</span><span class="p">:</span> <span class="n">default_weights_nmda</span><span class="p">,</span>
            <span class="s1">&#39;delays&#39;</span><span class="p">:</span> <span class="n">default_delays</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">drive_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">numspikes</span><span class="p">,</span> <span class="n">seedcore</span><span class="p">,</span> <span class="n">sync_inputs</span><span class="p">]</span> <span class="o">+</span>
                     <span class="n">widgets_list</span><span class="p">)</span>
    <span class="n">drive</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Evoked&#39;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span>
                 <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                 <span class="n">numspikes</span><span class="o">=</span><span class="n">numspikes</span><span class="p">,</span>
                 <span class="n">seedcore</span><span class="o">=</span><span class="n">seedcore</span><span class="p">,</span>
                 <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                 <span class="n">sync_within_trial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">is_synch_inputs</span><span class="o">=</span><span class="n">sync_inputs</span><span class="p">)</span>
    <span class="n">drive</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">widgets_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span>


<span class="k">def</span> <span class="nf">_get_tonic_widget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;amplitude&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;t0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;tstop&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="n">cell_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L2_basket&#39;</span><span class="p">,</span> <span class="s1">&#39;L2_pyramidal&#39;</span><span class="p">,</span> <span class="s1">&#39;L5_basket&#39;</span><span class="p">,</span> <span class="s1">&#39;L5_pyramidal&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">default_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="n">amplitudes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">default_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cell_type</span><span class="p">])</span>
        <span class="n">amplitudes</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]),</span>
            <span class="n">description</span><span class="o">=</span><span class="n">cell_type</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">start_times</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start time&quot;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">stop_times</span> <span class="o">=</span> <span class="n">BoundedFloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_data</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Stop time&quot;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">widgets_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;amplitude&#39;</span><span class="p">:</span> <span class="n">amplitudes</span><span class="p">,</span>
        <span class="s1">&#39;t0&#39;</span><span class="p">:</span> <span class="n">start_times</span><span class="p">,</span>
        <span class="s1">&#39;tstop&#39;</span><span class="p">:</span> <span class="n">stop_times</span>
    <span class="p">}</span>
    <span class="n">widgets_list</span> <span class="o">=</span> <span class="p">([</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;Times (ms):&lt;/b&gt;&quot;</span><span class="p">)]</span> <span class="o">+</span>
                    <span class="p">[</span><span class="n">start_times</span><span class="p">,</span> <span class="n">stop_times</span><span class="p">]</span> <span class="o">+</span>
                    <span class="p">[</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;Amplitude (nA):&lt;/b&gt;&quot;</span><span class="p">)]</span> <span class="o">+</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">amplitudes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">drive_box</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">(</span><span class="n">widgets_list</span><span class="p">)</span>
    <span class="n">drive</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Tonic&#39;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitudes</span><span class="p">,</span>
                 <span class="n">t0</span><span class="o">=</span><span class="n">start_times</span><span class="p">,</span>
                 <span class="n">tstop</span><span class="o">=</span><span class="n">stop_times</span><span class="p">,</span>
                 <span class="n">is_synch_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">drive</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">widgets_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span>


<span class="k">def</span> <span class="nf">add_drive_widget</span><span class="p">(</span><span class="n">drive_type</span><span class="p">,</span> <span class="n">drive_boxes</span><span class="p">,</span> <span class="n">drive_widgets</span><span class="p">,</span> <span class="n">drives_out</span><span class="p">,</span>
                     <span class="n">tstop_widget</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span>
                     <span class="n">prespecified_drive_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">prespecified_drive_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">prespecified_weights_ampa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">prespecified_weights_nmda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">prespecified_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">expand_last_drive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">event_seed</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                     <span class="n">sync_evinput</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a widget for a new drive.&quot;&quot;&quot;</span>

    <span class="c1"># Check only adds 1 tonic input widget</span>
    <span class="k">if</span> <span class="n">drive_type</span> <span class="o">==</span> <span class="s2">&quot;Tonic&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_valid_add_tonic_input</span><span class="p">(</span><span class="n">drive_widgets</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;125px&#39;</span><span class="p">}</span>
    <span class="n">drives_out</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prespecified_drive_data</span><span class="p">:</span>
        <span class="n">prespecified_drive_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prespecified_drive_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;seedcore&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">event_seed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)})</span>

    <span class="k">with</span> <span class="n">drives_out</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prespecified_drive_name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">drive_type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drive_boxes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">prespecified_drive_name</span>
        <span class="k">if</span> <span class="n">drive_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Rhythmic&#39;</span><span class="p">,</span> <span class="s1">&#39;Bursty&#39;</span><span class="p">):</span>
            <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span> <span class="o">=</span> <span class="n">_get_rhythmic_widget</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">tstop_widget</span><span class="p">,</span>
                <span class="n">layout</span><span class="p">,</span>
                <span class="n">style</span><span class="p">,</span>
                <span class="n">location</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">prespecified_drive_data</span><span class="p">,</span>
                <span class="n">default_weights_ampa</span><span class="o">=</span><span class="n">prespecified_weights_ampa</span><span class="p">,</span>
                <span class="n">default_weights_nmda</span><span class="o">=</span><span class="n">prespecified_weights_nmda</span><span class="p">,</span>
                <span class="n">default_delays</span><span class="o">=</span><span class="n">prespecified_delays</span><span class="p">,</span>
                <span class="n">sync_evinput</span><span class="o">=</span><span class="n">sync_evinput</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">drive_type</span> <span class="o">==</span> <span class="s1">&#39;Poisson&#39;</span><span class="p">:</span>
            <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span> <span class="o">=</span> <span class="n">_get_poisson_widget</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">tstop_widget</span><span class="p">,</span>
                <span class="n">layout</span><span class="p">,</span>
                <span class="n">style</span><span class="p">,</span>
                <span class="n">location</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">prespecified_drive_data</span><span class="p">,</span>
                <span class="n">default_weights_ampa</span><span class="o">=</span><span class="n">prespecified_weights_ampa</span><span class="p">,</span>
                <span class="n">default_weights_nmda</span><span class="o">=</span><span class="n">prespecified_weights_nmda</span><span class="p">,</span>
                <span class="n">default_delays</span><span class="o">=</span><span class="n">prespecified_delays</span><span class="p">,</span>
                <span class="n">sync_evinput</span><span class="o">=</span><span class="n">sync_evinput</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">drive_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Evoked&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">):</span>
            <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span> <span class="o">=</span> <span class="n">_get_evoked_widget</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">layout</span><span class="p">,</span>
                <span class="n">style</span><span class="p">,</span>
                <span class="n">location</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">prespecified_drive_data</span><span class="p">,</span>
                <span class="n">default_weights_ampa</span><span class="o">=</span><span class="n">prespecified_weights_ampa</span><span class="p">,</span>
                <span class="n">default_weights_nmda</span><span class="o">=</span><span class="n">prespecified_weights_nmda</span><span class="p">,</span>
                <span class="n">default_delays</span><span class="o">=</span><span class="n">prespecified_delays</span><span class="p">,</span>
                <span class="n">sync_evinput</span><span class="o">=</span><span class="n">sync_evinput</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">drive_type</span> <span class="o">==</span> <span class="s1">&#39;Tonic&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">drive_type</span>
            <span class="n">drive</span><span class="p">,</span> <span class="n">drive_box</span> <span class="o">=</span> <span class="n">_get_tonic_widget</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">layout</span><span class="p">,</span>
                <span class="n">style</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">prespecified_drive_data</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">drive_type</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;Evoked&#39;</span><span class="p">,</span> <span class="s1">&#39;Poisson&#39;</span><span class="p">,</span> <span class="s1">&#39;Rhythmic&#39;</span><span class="p">,</span> <span class="s1">&#39;Bursty&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Tonic&#39;</span>
        <span class="p">]:</span>
            <span class="n">drive_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drive_box</span><span class="p">)</span>
            <span class="n">drive_widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">render</span><span class="p">:</span>
            <span class="n">accordion</span> <span class="o">=</span> <span class="n">Accordion</span><span class="p">(</span>
                <span class="n">children</span><span class="o">=</span><span class="n">drive_boxes</span><span class="p">,</span>
                <span class="n">selected_index</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">drive_boxes</span><span class="p">)</span> <span class="o">-</span>
                <span class="mi">1</span> <span class="k">if</span> <span class="n">expand_last_drive</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">drive</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drive_widgets</span><span class="p">):</span>
                <span class="n">tab_name</span> <span class="o">=</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;Tonic&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab_name</span><span class="p">:</span>
                    <span class="n">tab_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">accordion</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">)</span>

            <span class="n">display</span><span class="p">(</span><span class="n">accordion</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_connectivity_tab</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">connectivity_out</span><span class="p">,</span>
                         <span class="n">connectivity_textfields</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add all possible connectivity boxes to connectivity tab.&quot;&quot;&quot;</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">jones_2009_model</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">cell_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">cell_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">receptors</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ampa&#39;</span><span class="p">,</span> <span class="s1">&#39;nmda&#39;</span><span class="p">,</span> <span class="s1">&#39;gabaa&#39;</span><span class="p">,</span> <span class="s1">&#39;gabab&#39;</span><span class="p">)</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;proximal&#39;</span><span class="p">,</span> <span class="s1">&#39;distal&#39;</span><span class="p">,</span> <span class="s1">&#39;soma&#39;</span><span class="p">)</span>

    <span class="c1"># clear existing connectivity</span>
    <span class="n">connectivity_out</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">connectivity_textfields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">connectivity_textfields</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">connectivity_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">src_gids</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">target_gids</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
                <span class="c1"># the connectivity list should be built on this level</span>
                <span class="n">receptor_related_conn</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">receptor</span> <span class="ow">in</span> <span class="n">receptors</span><span class="p">:</span>
                    <span class="n">conn_indices</span> <span class="o">=</span> <span class="n">pick_connection</span><span class="p">(</span><span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span>
                                                   <span class="n">src_gids</span><span class="o">=</span><span class="n">src_gids</span><span class="p">,</span>
                                                   <span class="n">target_gids</span><span class="o">=</span><span class="n">target_gids</span><span class="p">,</span>
                                                   <span class="n">loc</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                                                   <span class="n">receptor</span><span class="o">=</span><span class="n">receptor</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conn_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">conn_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="n">conn_idx</span> <span class="o">=</span> <span class="n">conn_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">current_w</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span>
                            <span class="n">conn_idx</span><span class="p">][</span><span class="s1">&#39;nc_dict&#39;</span><span class="p">][</span><span class="s1">&#39;A_weight&#39;</span><span class="p">]</span>
                        <span class="n">current_p</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span>
                            <span class="n">conn_idx</span><span class="p">][</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span>
                        <span class="c1"># valid connection</span>
                        <span class="n">receptor_related_conn</span><span class="p">[</span><span class="n">receptor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">current_w</span><span class="p">,</span>
                            <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">current_p</span><span class="p">,</span>
                            <span class="c1"># info used to identify connection</span>
                            <span class="s2">&quot;receptor&quot;</span><span class="p">:</span> <span class="n">receptor</span><span class="p">,</span>
                            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
                            <span class="s2">&quot;src_gids&quot;</span><span class="p">:</span> <span class="n">src_gids</span><span class="p">,</span>
                            <span class="s2">&quot;target_gids&quot;</span><span class="p">:</span> <span class="n">target_gids</span><span class="p">,</span>
                        <span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">receptor_related_conn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">connectivity_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_gids</span><span class="si">}</span><span class="s2">→</span><span class="si">{</span><span class="n">target_gids</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">connectivity_textfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">_get_connectivity_widgets</span><span class="p">(</span><span class="n">receptor_related_conn</span><span class="p">))</span>

    <span class="n">connectivity_boxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">VBox</span><span class="p">(</span><span class="n">slider</span><span class="p">)</span> <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="n">connectivity_textfields</span><span class="p">]</span>
    <span class="n">cell_connectivity</span> <span class="o">=</span> <span class="n">Accordion</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">connectivity_boxes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">connectivity_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">connectivity_names</span><span class="p">):</span>
        <span class="n">cell_connectivity</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">connectivity_name</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">connectivity_out</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">cell_connectivity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">net</span>


<span class="k">def</span> <span class="nf">add_drive_tab</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">log_out</span><span class="p">,</span> <span class="n">drives_out</span><span class="p">,</span> <span class="n">drive_widgets</span><span class="p">,</span> <span class="n">drive_boxes</span><span class="p">,</span>
                  <span class="n">tstop</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">jones_2009_model</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">drive_specs</span> <span class="o">=</span> <span class="n">_extract_drive_specs_from_hnn_params</span><span class="p">(</span>
        <span class="n">net</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">cell_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">legacy_mode</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">_legacy_mode</span><span class="p">)</span>

    <span class="c1"># clear before adding drives</span>
    <span class="n">drives_out</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">drive_widgets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">drive_widgets</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">drive_boxes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">drive_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">drive_specs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">drive_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drive_names</span><span class="p">):</span>  <span class="c1"># order matters</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="n">drive_specs</span><span class="p">[</span><span class="n">drive_name</span><span class="p">]</span>
        <span class="n">should_render</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drive_names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">is_sync_evinput</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;cell_specific&#39;</span><span class="p">]</span> <span class="ow">and</span>
                           <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;dynamics&#39;</span><span class="p">][</span><span class="s1">&#39;n_drive_cells&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">add_drive_widget</span><span class="p">(</span>
            <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
            <span class="n">drive_boxes</span><span class="p">,</span>
            <span class="n">drive_widgets</span><span class="p">,</span>
            <span class="n">drives_out</span><span class="p">,</span>
            <span class="n">tstop</span><span class="p">,</span>
            <span class="n">specs</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
            <span class="n">prespecified_drive_name</span><span class="o">=</span><span class="n">drive_name</span><span class="p">,</span>
            <span class="n">prespecified_drive_data</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;dynamics&#39;</span><span class="p">],</span>
            <span class="n">prespecified_weights_ampa</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;weights_ampa&#39;</span><span class="p">],</span>
            <span class="n">prespecified_weights_nmda</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;weights_nmda&#39;</span><span class="p">],</span>
            <span class="n">prespecified_delays</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;synaptic_delays&#39;</span><span class="p">],</span>
            <span class="n">render</span><span class="o">=</span><span class="n">should_render</span><span class="p">,</span>
            <span class="n">expand_last_drive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">event_seed</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;event_seed&#39;</span><span class="p">],</span>
            <span class="n">sync_evinput</span><span class="o">=</span><span class="n">is_sync_evinput</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">load_drive_and_connectivity</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">log_out</span><span class="p">,</span> <span class="n">drives_out</span><span class="p">,</span>
                                <span class="n">drive_widgets</span><span class="p">,</span> <span class="n">drive_boxes</span><span class="p">,</span> <span class="n">connectivity_out</span><span class="p">,</span>
                                <span class="n">connectivity_textfields</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add drive and connectivity ipywidgets from params.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
        <span class="c1"># Add connectivity</span>
        <span class="n">add_connectivity_tab</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">connectivity_out</span><span class="p">,</span>
                             <span class="n">connectivity_textfields</span><span class="p">)</span>
        <span class="c1"># Add drives</span>
        <span class="n">add_drive_tab</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">log_out</span><span class="p">,</span> <span class="n">drives_out</span><span class="p">,</span> <span class="n">drive_widgets</span><span class="p">,</span> <span class="n">drive_boxes</span><span class="p">,</span>
                      <span class="n">tstop</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">on_upload_data_change</span><span class="p">(</span><span class="n">change</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">viz_manager</span><span class="p">,</span> <span class="n">log_out</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">data_dict</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">dict_name</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">data_fname</span> <span class="o">=</span> <span class="n">dict_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_extension</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">dict_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">data_fname</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;simulation_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found existing data: </span><span class="si">{</span><span class="n">data_fname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">ext_content</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
    <span class="n">ext_content</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ext_content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;simulation_data&#39;</span><span class="p">][</span><span class="n">data_fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;dpls&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">_read_dipole_txt</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">ext_content</span><span class="p">),</span> <span class="n">file_extension</span><span class="p">)</span>
        <span class="p">]}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;External data </span><span class="si">{</span><span class="n">data_fname</span><span class="si">}</span><span class="s1"> loaded.&#39;</span><span class="p">)</span>
        <span class="n">_template_name</span> <span class="o">=</span> <span class="s2">&quot;[Blank] single figure&quot;</span>
        <span class="n">viz_manager</span><span class="o">.</span><span class="n">reset_fig_config_tabs</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="n">_template_name</span><span class="p">)</span>
        <span class="n">viz_manager</span><span class="o">.</span><span class="n">add_figure</span><span class="p">()</span>
        <span class="n">fig_name</span> <span class="o">=</span> <span class="n">_idx2figname</span><span class="p">(</span><span class="n">viz_manager</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fig_idx&#39;</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_plots</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;ax0&quot;</span><span class="p">,</span> <span class="s2">&quot;current dipole&quot;</span><span class="p">)]</span>

        <span class="c1"># these lines plot the data per axis</span>
        <span class="k">for</span> <span class="n">ax_name</span><span class="p">,</span> <span class="n">plot_type</span> <span class="ow">in</span> <span class="n">ax_plots</span><span class="p">:</span>
            <span class="n">viz_manager</span><span class="o">.</span><span class="n">_simulate_edit_figure</span><span class="p">(</span>
                <span class="n">fig_name</span><span class="p">,</span> <span class="n">ax_name</span><span class="p">,</span> <span class="n">data_fname</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;plot&quot;</span><span class="p">)</span>
        <span class="n">change</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">on_upload_params_change</span><span class="p">(</span><span class="n">change</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">log_out</span><span class="p">,</span> <span class="n">drive_boxes</span><span class="p">,</span>
                            <span class="n">drive_widgets</span><span class="p">,</span> <span class="n">drives_out</span><span class="p">,</span> <span class="n">connectivity_out</span><span class="p">,</span>
                            <span class="n">connectivity_textfields</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">load_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params_fname</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">file_contents</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">read_params</span><span class="p">(</span><span class="n">params_fname</span><span class="p">,</span> <span class="n">file_contents</span><span class="p">)</span>

    <span class="c1"># update simulation settings and params</span>
    <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;tstop&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tstop</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;dt&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>

    <span class="c1"># init network, add drives &amp; connectivity</span>
    <span class="k">if</span> <span class="n">load_type</span> <span class="o">==</span> <span class="s1">&#39;connectivity&#39;</span><span class="p">:</span>
        <span class="n">add_connectivity_tab</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">connectivity_out</span><span class="p">,</span> <span class="n">connectivity_textfields</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">load_type</span> <span class="o">==</span> <span class="s1">&#39;drives&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
            <span class="n">add_drive_tab</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">log_out</span><span class="p">,</span> <span class="n">drives_out</span><span class="p">,</span> <span class="n">drive_widgets</span><span class="p">,</span>
                          <span class="n">drive_boxes</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="c1"># Resets file counter to 0</span>
    <span class="n">change</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_trait</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="p">([]))</span>


<span class="k">def</span> <span class="nf">_init_network_from_widgets</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">single_simulation_data</span><span class="p">,</span>
                               <span class="n">drive_widgets</span><span class="p">,</span> <span class="n">connectivity_textfields</span><span class="p">,</span>
                               <span class="n">add_drive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct network and add drives.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;init network&quot;</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">value</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tstop</span><span class="o">.</span><span class="n">value</span>
    <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jones_2009_model</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">add_drives_from_params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># adjust connectivity according to the connectivity_tab</span>
    <span class="k">for</span> <span class="n">connectivity_slider</span> <span class="ow">in</span> <span class="n">connectivity_textfields</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">vbox</span> <span class="ow">in</span> <span class="n">connectivity_slider</span><span class="p">:</span>
            <span class="n">conn_indices</span> <span class="o">=</span> <span class="n">pick_connection</span><span class="p">(</span>
                <span class="n">net</span><span class="o">=</span><span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">],</span>
                <span class="n">src_gids</span><span class="o">=</span><span class="n">vbox</span><span class="o">.</span><span class="n">_belongsto</span><span class="p">[</span><span class="s1">&#39;src_gids&#39;</span><span class="p">],</span>
                <span class="n">target_gids</span><span class="o">=</span><span class="n">vbox</span><span class="o">.</span><span class="n">_belongsto</span><span class="p">[</span><span class="s1">&#39;target_gids&#39;</span><span class="p">],</span>
                <span class="n">loc</span><span class="o">=</span><span class="n">vbox</span><span class="o">.</span><span class="n">_belongsto</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                <span class="n">receptor</span><span class="o">=</span><span class="n">vbox</span><span class="o">.</span><span class="n">_belongsto</span><span class="p">[</span><span class="s1">&#39;receptor&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conn_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">conn_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">conn_idx</span> <span class="o">=</span> <span class="n">conn_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span><span class="n">conn_idx</span><span class="p">][</span>
                    <span class="s1">&#39;nc_dict&#39;</span><span class="p">][</span><span class="s1">&#39;A_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbox</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">connectivity</span><span class="p">[</span><span class="n">conn_idx</span><span class="p">][</span>
                    <span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbox</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="k">if</span> <span class="n">add_drive</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># add drives to network</span>
    <span class="k">for</span> <span class="n">drive</span> <span class="ow">in</span> <span class="n">drive_widgets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Tonic&#39;</span><span class="p">):</span>
            <span class="n">weights_amplitudes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drive</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_tonic_bias</span><span class="p">(</span>
                <span class="n">amplitude</span><span class="o">=</span><span class="n">weights_amplitudes</span><span class="p">,</span>
                <span class="n">t0</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">tstop</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">synch_inputs_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;is_synch_inputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">synch_inputs_kwargs</span><span class="p">[</span><span class="s1">&#39;n_drive_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">synch_inputs_kwargs</span><span class="p">[</span><span class="s1">&#39;cell_specific&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">weights_ampa</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;weights_ampa&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">weights_nmda</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;weights_nmda&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">synaptic_delays</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;delays&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;drive type is </span><span class="si">{</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, location=</span><span class="si">{</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Poisson&#39;</span><span class="p">:</span>
                <span class="n">rate_constant</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;rate_constant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">}</span>
                <span class="n">weights_ampa</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">weights_ampa</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rate_constant</span>
                <span class="p">}</span>
                <span class="n">weights_nmda</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">weights_nmda</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rate_constant</span>
                <span class="p">}</span>
                <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_poisson_drive</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">tstart</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">tstop</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">rate_constant</span><span class="o">=</span><span class="n">rate_constant</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                    <span class="n">weights_ampa</span><span class="o">=</span><span class="n">weights_ampa</span><span class="p">,</span>
                    <span class="n">weights_nmda</span><span class="o">=</span><span class="n">weights_nmda</span><span class="p">,</span>
                    <span class="n">synaptic_delays</span><span class="o">=</span><span class="n">synaptic_delays</span><span class="p">,</span>
                    <span class="n">space_constant</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
                    <span class="n">event_seed</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;seedcore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">synch_inputs_kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Evoked&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">):</span>
                <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_evoked_drive</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">mu</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">sigma</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">numspikes</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;numspikes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                    <span class="n">weights_ampa</span><span class="o">=</span><span class="n">weights_ampa</span><span class="p">,</span>
                    <span class="n">weights_nmda</span><span class="o">=</span><span class="n">weights_nmda</span><span class="p">,</span>
                    <span class="n">synaptic_delays</span><span class="o">=</span><span class="n">synaptic_delays</span><span class="p">,</span>
                    <span class="n">space_constant</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                    <span class="n">event_seed</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;seedcore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">synch_inputs_kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Rhythmic&#39;</span><span class="p">,</span> <span class="s1">&#39;Bursty&#39;</span><span class="p">):</span>
                <span class="n">single_simulation_data</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_bursty_drive</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">tstart</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">tstart_std</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;tstart_std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">burst_rate</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;burst_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">burst_std</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;burst_std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                    <span class="n">tstop</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">weights_ampa</span><span class="o">=</span><span class="n">weights_ampa</span><span class="p">,</span>
                    <span class="n">weights_nmda</span><span class="o">=</span><span class="n">weights_nmda</span><span class="p">,</span>
                    <span class="n">synaptic_delays</span><span class="o">=</span><span class="n">synaptic_delays</span><span class="p">,</span>
                    <span class="n">event_seed</span><span class="o">=</span><span class="n">drive</span><span class="p">[</span><span class="s1">&#39;seedcore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">synch_inputs_kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_button_clicked</span><span class="p">(</span><span class="n">widget_simulation_name</span><span class="p">,</span> <span class="n">log_out</span><span class="p">,</span> <span class="n">drive_widgets</span><span class="p">,</span>
                       <span class="n">all_data</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">ntrials</span><span class="p">,</span> <span class="n">backend_selection</span><span class="p">,</span>
                       <span class="n">mpi_cmd</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">simulation_status_bar</span><span class="p">,</span>
                       <span class="n">simulation_status_contents</span><span class="p">,</span> <span class="n">connectivity_textfields</span><span class="p">,</span>
                       <span class="n">viz_manager</span><span class="p">,</span> <span class="n">simulations_list_widget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the simulation and plot outputs.&quot;&quot;&quot;</span>
    <span class="n">simulation_data</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="s2">&quot;simulation_data&quot;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
        <span class="c1"># clear empty trash simulations</span>
        <span class="k">for</span> <span class="n">_name</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">simulation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simulation_data</span><span class="p">[</span><span class="n">_name</span><span class="p">][</span><span class="s1">&#39;dpls&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">simulation_data</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span>

        <span class="n">_sim_name</span> <span class="o">=</span> <span class="n">widget_simulation_name</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">simulation_data</span><span class="p">[</span><span class="n">_sim_name</span><span class="p">][</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulation with the same name exists!&quot;</span><span class="p">)</span>
            <span class="n">simulation_status_bar</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">simulation_status_contents</span><span class="p">[</span>
                <span class="s1">&#39;failed&#39;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="n">_init_network_from_widgets</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span>
                                   <span class="n">simulation_data</span><span class="p">[</span><span class="n">_sim_name</span><span class="p">],</span> <span class="n">drive_widgets</span><span class="p">,</span>
                                   <span class="n">connectivity_textfields</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start simulation&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backend_selection</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;MPI&quot;</span><span class="p">:</span>
            <span class="n">backend</span> <span class="o">=</span> <span class="n">MPIBackend</span><span class="p">(</span>
                <span class="n">n_procs</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mpi_cmd</span><span class="o">=</span><span class="n">mpi_cmd</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backend</span> <span class="o">=</span> <span class="n">JoblibBackend</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Joblib with </span><span class="si">{</span><span class="n">n_jobs</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> core(s).&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">backend</span><span class="p">:</span>
            <span class="n">simulation_status_bar</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">simulation_status_contents</span><span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]</span>
            <span class="n">simulation_data</span><span class="p">[</span><span class="n">_sim_name</span><span class="p">][</span><span class="s1">&#39;dpls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulate_dipole</span><span class="p">(</span>
                <span class="n">simulation_data</span><span class="p">[</span><span class="n">_sim_name</span><span class="p">][</span><span class="s1">&#39;net&#39;</span><span class="p">],</span>
                <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">n_trials</span><span class="o">=</span><span class="n">ntrials</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="n">simulation_status_bar</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">simulation_status_contents</span><span class="p">[</span>
                <span class="s1">&#39;finished&#39;</span><span class="p">]</span>

            <span class="n">sim_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">sim_name</span> <span class="k">for</span> <span class="n">sim_name</span>
                         <span class="ow">in</span> <span class="n">simulation_data</span><span class="p">]</span>
            <span class="n">simulations_list_widget</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">sim_names</span>
            <span class="n">simulations_list_widget</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">sim_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">viz_manager</span><span class="o">.</span><span class="n">reset_fig_config_tabs</span><span class="p">()</span>
    <span class="n">viz_manager</span><span class="o">.</span><span class="n">add_figure</span><span class="p">()</span>
    <span class="n">fig_name</span> <span class="o">=</span> <span class="n">_idx2figname</span><span class="p">(</span><span class="n">viz_manager</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fig_idx&#39;</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax_plots</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;ax0&quot;</span><span class="p">,</span> <span class="s2">&quot;input histogram&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;ax1&quot;</span><span class="p">,</span> <span class="s2">&quot;current dipole&quot;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">ax_name</span><span class="p">,</span> <span class="n">plot_type</span> <span class="ow">in</span> <span class="n">ax_plots</span><span class="p">:</span>
        <span class="n">viz_manager</span><span class="o">.</span><span class="n">_simulate_edit_figure</span><span class="p">(</span><span class="n">fig_name</span><span class="p">,</span> <span class="n">ax_name</span><span class="p">,</span> <span class="n">_sim_name</span><span class="p">,</span>
                                          <span class="n">plot_type</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;plot&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_serialize_simulation</span><span class="p">(</span><span class="n">log_out</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">,</span> <span class="n">simulation_list_widget</span><span class="p">):</span>
    <span class="c1"># Only download if there is there is at least one simulation</span>
    <span class="n">sim_name</span> <span class="o">=</span> <span class="n">simulation_list_widget</span><span class="o">.</span><span class="n">value</span>

    <span class="k">with</span> <span class="n">log_out</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving </span><span class="si">{</span><span class="n">sim_name</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">serialize_simulation</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">sim_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">serialize_simulation</span><span class="p">(</span><span class="n">simulations_data</span><span class="p">,</span> <span class="n">simulation_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serializes simulation data to CSV.</span>

<span class="sd">        Creates a single CSV file or a ZIP file containing multiple CSVs,</span>
<span class="sd">        depending on the number of trials in the simulation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">simulation_data</span> <span class="o">=</span> <span class="n">simulations_data</span><span class="p">[</span><span class="s2">&quot;simulation_data&quot;</span><span class="p">]</span>
    <span class="n">csv_trials_output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># CSV file hearders</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="s1">&#39;times,agg,L2,L5&#39;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span>

    <span class="k">for</span> <span class="n">dpl_trial</span> <span class="ow">in</span> <span class="n">simulation_data</span><span class="p">[</span><span class="n">simulation_name</span><span class="p">][</span><span class="s1">&#39;dpls&#39;</span><span class="p">]:</span>
        <span class="c1"># Combine all data columns at once</span>
        <span class="n">signals_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span>
            <span class="n">dpl_trial</span><span class="o">.</span><span class="n">times</span><span class="p">,</span>
            <span class="n">dpl_trial</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;agg&#39;</span><span class="p">],</span>
            <span class="n">dpl_trial</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;L2&#39;</span><span class="p">],</span>
            <span class="n">dpl_trial</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;L5&#39;</span><span class="p">]</span>
        <span class="p">))</span>

        <span class="c1"># Using StringIO to collect CSV data</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">signals_matrix</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
                       <span class="n">header</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
            <span class="n">csv_trials_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">csv_trials_output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Return a single csv file</span>
        <span class="k">return</span> <span class="n">csv_trials_output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;.csv&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create zip file</span>
        <span class="k">return</span> <span class="n">_create_zip</span><span class="p">(</span><span class="n">csv_trials_output</span><span class="p">,</span> <span class="n">simulation_name</span><span class="p">),</span> <span class="s2">&quot;.zip&quot;</span>


<span class="k">def</span> <span class="nf">_create_zip</span><span class="p">(</span><span class="n">csv_data_list</span><span class="p">,</span> <span class="n">simulation_name</span><span class="p">):</span>
    <span class="c1"># Zip all files and keep it in memory</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">zip_buffer</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_buffer</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">csv_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_data_list</span><span class="p">):</span>
                <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">simulation_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">csv_data</span><span class="p">)</span>
        <span class="n">zip_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zip_buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">handle_backend_change</span><span class="p">(</span><span class="n">backend_type</span><span class="p">,</span> <span class="n">backend_config</span><span class="p">,</span> <span class="n">mpi_cmd</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Switch backends between MPI and Joblib.&quot;&quot;&quot;</span>
    <span class="n">backend_config</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">backend_config</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="s2">&quot;MPI&quot;</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">mpi_cmd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">backend_type</span> <span class="o">==</span> <span class="s2">&quot;Joblib&quot;</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_valid_add_tonic_input</span><span class="p">(</span><span class="n">drive_widgets</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">drive</span> <span class="ow">in</span> <span class="n">drive_widgets</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Tonic&quot;</span> <span class="ow">in</span> <span class="n">drive</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">launch</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Launch voila with hnn_widget.ipynb.</span>

<span class="sd">    You can pass voila commandline parameters as usual.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">voila.app</span> <span class="kn">import</span> <span class="n">main</span>
    <span class="n">notebook_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;hnn_widget.ipynb&#39;</span>
    <span class="n">main</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">notebook_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span> <span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2023, HNN Developers.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7.<br/>
    </p>
  </div>
</footer>
  </body>
</html>